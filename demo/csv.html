 <!DOCTYPE html>
<html>
<head>
	<title></title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script src="js/papaparse.js"></script>
</head>
<body>
	<input id="file" type="file" name="csv" value="" />
</body>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script src="https://www.gstatic.com/firebasejs/3.3.0/firebase.js"></script>
  </script>
<script>
	// set to put it in
	// once confirm exists, use update to add new fields
	$(document).ready(function() {

		File.prototype.convertToBase64 = function(callback){
      var reader = new FileReader();
      reader.onload = function(e) {
           callback(e.target.result)
      };
      reader.onerror = function(e) {
           callback(null);
      };        
      reader.readAsDataURL(this);
    };

		$('#file').change(function (e) {
			if ($('#company').val() == "") {
				alert("Please enter a company name to add csv file to");
				return false;
			}
			var selectedFile = this.files[0];

			// check if submitted valid file
			/*if (file && (file.substring(file.name.length - 4) == '.png' || 
				file.substring(file.name.length - 4) == '.jpg')) {
		    	selectedFile.convertToBase64(function(base64){
		           console.log(base64);
		    	}) 
			} else {
				alert("Please upload a valid .PNG or .JPG file");
			}*/
			// check if valid file
			if (file && file.substring(file.name.length - 4) == ".csv") {
				Papa.parse(file, {
					complete: function(results) {
						var data = results.data;
						console.log(results.data)
						for (var i = 0; i < data.length; i++) {
							// todo, what to do in the event if given iproper format		
							if (data[i].length == 2) {
								var obj = {};
								var departmentList = [];
								console.log(data[i][0], data[i][1]);
								if (typeof obj[data[i][0]] === 'undefined') {
									obj[data[i][0]] = [];
									departmentList.push(data[i][0]);
								}
								obj[data[i][0]].push(data[i][1]);
							}
						}
						var exists = false;
						var companyId = ""
						for (var key in companies) {
							if (companies[key].companyName == company) {
								console.log("similar company found");
								exists = true;
								companyId = key;
								break;
							}
						}

						if (!exists) {
							// no need to check everything is new, just create everything
							companyId = firebase.database().ref().child('/Companies').push().key;
							keyList = [];
							var departmentObj = {}

							for (var i = 0; i < departmentList.length; i++) {
								var departmentKey = firebase.database().ref().child('/Departments/' + companyId).push().key;
								// later used to allow easier mapping between department and products
								keyList.push(departmentKey);
								departmentObj[departmentKey] = departmentList[i];	
							}

							// need list of products with department key to object of products
							var updates = {};
							var productObj = {};

							// create our mapping for our department to product
							/**
							ex:
							productObj = {
								'department_id': {
									'product1': "fish",
									'product2': "grain",
								}
							}
							*/
							for (var i = 0; i < departmentList.length; i++) {
								productObj[keyList[i]] == {};
								for (var j = 0; j < obj[departmentList[i]].length; j++) {
									var products = obj[departmentList[i]];
									if (products[j] != "") {
										var name = "product" + (j + 1);
										productObj[keyList[i]][name] = products[j];
									}
								}
							}

							updates['/Companies/' + companyId] = companyObj;
							updates['/Departments/' + companyId] = departmentObj;
							for (var key in productObj) {
								updates['/Products/' + key] = productObj[key]; 								
							}
							firebase.database().ref().update(updates);
							finished();
						} else {
							
						}
					}
				});
			} else {
				alert("Please upload a valid CSV file.")
			}

		});
	});
</script>
</html>